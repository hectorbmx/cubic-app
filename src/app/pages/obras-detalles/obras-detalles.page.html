<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>
      <span class="obra-title">
        DETALLES DE LA OBRA
      </span>
    </ion-title>
    <app-user-menu slot="end"></app-user-menu>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando detalles...</p>
  </div>

  <!-- Error -->
  <div class="error-container" *ngIf="error && !loading">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <p>{{ error }}</p>
    <ion-button size="small" (click)="loadObraDetalle()">Reintentar</ion-button>
  </div>

  <!-- Contenido -->
  <div *ngIf="!loading && !error && obra" class="obra-container">
    <!-- Header Card -->
    <div class="obra-header-card">
      <!-- Título y Estado -->
      <div class="header-top">
        <h1 class="obra-nombre">{{ obra.nombre }}</h1>
        <span class="estado-badge" [style.background-color]="getStatusColor(obra.estado)">
          {{ getStatusLabel(obra.estado) }}
        </span>
      </div>

      <!-- Responsable -->
      <div class="responsable-section">
        <ion-icon name="person-outline" class="responsable-icon"></ion-icon>
        <span class="responsable-nombre">{{ obra.responsable?.nombre || 'Sin asignar' }}</span>
      </div>

      <!-- Fechas -->
      <div class="fechas-grid">
        <div class="fecha-item">
          <ion-icon name="calendar-outline"></ion-icon>
          <div class="fecha-content">
            <span class="fecha-label">Inicio</span>
            <span class="fecha-value">{{ obra.fechaInicio || 'Sin fecha' }}</span>
          </div>
        </div>
        <div class="fecha-item">
          <ion-icon name="calendar-outline"></ion-icon>
          <div class="fecha-content">
            <span class="fecha-label">Finalización</span>
            <span class="fecha-value">{{ obra.fechaFin || 'Sin fecha' }}</span>
          </div>
        </div>
      </div>

      <!-- Progreso -->
      <div class="progress-section">
        <div class="progress-header">
          <span class="progress-label">Progreso</span>
          <span class="progress-percent">{{ obra.progreso || 0 }}%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" 
               [style.width.%]="obra.progreso || 0"
               [style.background-color]="getProgressColor(obra.progreso)"></div>
        </div>
      </div>
    </div>

    <!-- Secciones Colapsables -->
    <div class="sections-container">
      
      <!-- Información General -->
      <div class="collapsible-section">
        <div class="section-header" (click)="toggleSection('informacion')">
          <div class="section-header-content">
            <ion-icon name="document-text-outline" class="section-icon"></ion-icon>
            <span class="section-title">Información General</span>
          </div>
          <ion-icon 
            [name]="expandedSections['informacion'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['informacion']">
          <div class="info-list">
            <div class="info-row" *ngIf="obra.codigo">
              <span class="label">Código:</span>
              <span class="value">{{ obra.codigo }}</span>
            </div>
            <div class="info-row" *ngIf="obra.cliente">
              <span class="label">Cliente:</span>
              <span class="value">{{ obra.cliente?.nombre || 'Sin cliente' }}</span>
            </div>
            <div class="info-row" *ngIf="obra.descripcion">
              <span class="label">Descripción:</span>
              <span class="value">{{ obra.descripcion }}</span>
            </div>
            <div class="info-row" *ngIf="obra.direccion">
              <span class="label">Dirección:</span>
              <span class="value">{{ obra.direccion }}</span>
            </div>
            <div class="info-row" *ngIf="obra.presupuesto">
              <span class="label">Presupuesto:</span>
              <span class="value">{{ obra.moneda || '' }} {{ formatNumber(obra.presupuesto) }}</span>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.codigo && !obra.cliente && !obra.descripcion && !obra.direccion && !obra.presupuesto">
            No hay información general disponible
          </p>
        </div>
      </div>

      <!-- Equipo de Trabajo -->
      <div class="collapsible-section" *ngIf="obra.equipo">
        <div class="section-header" (click)="toggleSection('equipo')">
          <div class="section-header-content">
            <ion-icon name="people-outline" class="section-icon"></ion-icon>
            <span class="section-title">Equipo de Trabajo</span>
          </div>
          <ion-icon 
            [name]="expandedSections['equipo'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['equipo']">
          <div class="list-items" *ngIf="obra.equipo && obra.equipo.length > 0">
            <div class="team-item" *ngFor="let miembro of obra.equipo">
              <div class="team-avatar">
                <ion-icon name="person-circle-outline"></ion-icon>
              </div>
              <div class="team-info">
                <h3>{{ miembro.nombre }}</h3>
                <p>{{ miembro.rol || 'Sin rol' }}</p>
              </div>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.equipo || obra.equipo.length === 0">
            No hay miembros del equipo registrados
          </p>
        </div>
      </div>

      <!-- Materiales -->
      <div class="collapsible-section" *ngIf="obra.materiales">
        <div class="section-header" (click)="toggleSection('materiales')">
          <div class="section-header-content">
            <ion-icon name="cube-outline" class="section-icon"></ion-icon>
            <span class="section-title">Materiales</span>
          </div>
          <ion-icon 
            [name]="expandedSections['materiales'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['materiales']">
          <div class="list-items" *ngIf="obra.materiales && obra.materiales.length > 0">
            <div class="material-item" *ngFor="let material of obra.materiales">
              <div class="material-info">
                <h3>{{ material.nombre }}</h3>
                <p>Cantidad: {{ material.cantidad }} {{ material.unidad }}</p>
              </div>
              <div class="material-status" [class.disponible]="material.disponible">
                {{ material.disponible ? 'Disponible' : 'No disponible' }}
              </div>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.materiales || obra.materiales.length === 0">
            No hay materiales registrados
          </p>
        </div>
      </div>

      <!-- Hitos del Proyecto -->
      <div class="collapsible-section">
        <div class="section-header" (click)="toggleSection('hitos')">
          <div class="section-header-content">
            <ion-icon name="flag-outline" class="section-icon"></ion-icon>
            <span class="section-title">Hitos del Proyecto</span>
          </div>
          <ion-icon 
            [name]="expandedSections['hitos'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['hitos']">
          <div class="list-items" *ngIf="obra.detalles && obra.detalles.length > 0">
            <div class="milestone-item" *ngFor="let detalle of obra.detalles">
              <div class="milestone-header">
                <h3>{{ detalle.titulo }}</h3>
                <span class="milestone-date">{{ detalle.fecha }}</span>
              </div>
              <p>{{ detalle.descripcion }}</p>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.detalles || obra.detalles.length === 0">
            No hay hitos registrados
          </p>
        </div>
      </div>

      <!-- Cámaras -->
      <div class="collapsible-section">
        <div class="section-header" (click)="toggleSection('camaras')">
          <div class="section-header-content">
            <ion-icon name="videocam-outline" class="section-icon"></ion-icon>
            <span class="section-title">Cámaras</span>
          </div>
          <ion-icon 
            [name]="expandedSections['camaras'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['camaras']">
          <div class="list-items" *ngIf="obra.camaras && obra.camaras.length > 0">
            <div class="camera-item" *ngFor="let camara of obra.camaras">
              <div class="camera-info">
                <h3>{{ camara.nombre }}</h3>
                <p class="camera-url">{{ camara.url }}</p>
              </div>
              <span class="camera-status" [class.active]="camara.activa">
                {{ camara.activa ? 'Activa' : 'Inactiva' }}
              </span>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.camaras || obra.camaras.length === 0">
            No hay cámaras registradas
          </p>
        </div>
      </div>

      <!-- Planos -->
      <div class="collapsible-section">
        <div class="section-header" (click)="toggleSection('planos')">
          <div class="section-header-content">
            <ion-icon name="document-outline" class="section-icon"></ion-icon>
            <span class="section-title">Planos</span>
          </div>
          <ion-icon 
            [name]="expandedSections['planos'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['planos']">
          <div class="list-items" *ngIf="obra.planos && obra.planos.length > 0">
            <div class="document-item clickable" *ngFor="let plano of obra.planos" (click)="openPlano(plano)">
              <ion-icon name="document-outline" class="document-icon"></ion-icon>
              <div class="document-info">
                <h3>{{ plano.nombre }}</h3>
                <span class="document-date">{{ plano.fecha }}</span>
              </div>
              <ion-icon name="chevron-forward-outline" class="action-icon"></ion-icon>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.planos || obra.planos.length === 0">
            No hay planos registrados
          </p>
        </div>
      </div>

      <!-- Contratos -->
      <div class="collapsible-section">
        <div class="section-header" (click)="toggleSection('contratos')">
          <div class="section-header-content">
            <ion-icon name="clipboard-outline" class="section-icon"></ion-icon>
            <span class="section-title">Contratos</span>
          </div>
          <ion-icon 
            [name]="expandedSections['contratos'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['contratos']">
          <div class="list-items" *ngIf="obra.contratos && obra.contratos.length > 0">
            <div class="document-item clickable" *ngFor="let contrato of obra.contratos" (click)="openContrato(contrato)">
              <ion-icon name="clipboard-outline" class="document-icon"></ion-icon>
              <div class="document-info">
                <h3>{{ contrato.nombre }}</h3>
                <span class="document-date">{{ contrato.fecha }}</span>
              </div>
              <ion-icon name="chevron-forward-outline" class="action-icon"></ion-icon>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.contratos || obra.contratos.length === 0">
            No hay contratos registrados
          </p>
        </div>
      </div>

      <!-- Informes -->
      <div class="collapsible-section" *ngIf="obra.informes">
        <div class="section-header" (click)="toggleSection('informes')">
          <div class="section-header-content">
            <ion-icon name="bar-chart-outline" class="section-icon"></ion-icon>
            <span class="section-title">Informes</span>
          </div>
          <ion-icon 
            [name]="expandedSections['informes'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['informes']">
          <div class="list-items" *ngIf="obra.informes && obra.informes.length > 0">
            <div class="document-item clickable" *ngFor="let informe of obra.informes" (click)="openInforme(informe)">
              <ion-icon name="document-text-outline" class="document-icon"></ion-icon>
              <div class="document-info">
                <h3>{{ informe.nombre }}</h3>
                <span class="document-date">{{ informe.fecha }}</span>
              </div>
              <ion-icon name="chevron-forward-outline" class="action-icon"></ion-icon>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.informes || obra.informes.length === 0">
            No hay informes registrados
          </p>
        </div>
      </div>

      <!-- Fotos -->
      <div class="collapsible-section">
        <div class="section-header" (click)="toggleSection('fotos')">
          <div class="section-header-content">
            <ion-icon name="images-outline" class="section-icon"></ion-icon>
            <span class="section-title">Fotos</span>
          </div>
          <ion-icon 
            [name]="expandedSections['fotos'] ? 'chevron-up-outline' : 'chevron-down-outline'"
            class="chevron-icon"></ion-icon>
        </div>
        <div class="section-content" *ngIf="expandedSections['fotos']">
          <div class="photos-grid" *ngIf="obra.fotos && obra.fotos.length > 0">
            <div class="photo-item" *ngFor="let foto of obra.fotos" (click)="openFoto(foto)">
              <img [src]="foto.thumbnail || foto.url" [alt]="foto.descripcion">
              <p>{{ foto.descripcion }}</p>
            </div>
          </div>
          <p class="placeholder-text" *ngIf="!obra.fotos || obra.fotos.length === 0">
            No hay fotos registradas
          </p>
        </div>
      </div>

    </div>
  </div>
</ion-content>